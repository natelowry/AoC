//AOC20a
var practice = `..#.#..#####.#.#.#.###.##.....###.##.#..###.####..#####..#....#..#..##..###..######.###...####..#..#####..##..#.#####...##.#.#..#.##..#.#......#.###.######.###.####...#.##.##..#..#..#####.....#.#....###..#.##......#.....#..#..#..##..#...##.######.####.####.#.#...#.......#..#.#.#...####.##.#......#..#...##.#.##..#...##.#.##..###.#......#.#.......#.#.#.####.###.##...#.....####.#..#..#.##.#....##..#.####....##...##..#...#......#.#.......#.......##..####..#...#.#.#...##..#.#..###..#####........#..####......#..#

#..#.
#....
##..#
..#..
..###`;

var real = `####....#.....##.####..#.##.###.########.##.#..#.##.#...#..##.######..#......#..###.#.##.####.#.#.#....######.###...###.#.###.####..###.......#..#.#.#.#.#.####..####.#..####.#..####..##.#.#.#.###..##..#....#...###.#....###....##.###...##..#..#..#...##...#.#..#..###...####.#.#.###..#.#.#..###.##.##.#..###...#.#.#.##...#...#..#...##..###..###..#...###.#....#.##.#.####...##...##.#.####.#####.##...#######.###..##.#####.##.....####.#######.#.#.##....#...##...#..##.###.######.#######.#.#.#....#..##.###.#..##..##.

###..#..........#.#.###.###.#.#..###.#.###.###.#....#.#.....###.#...#####.####...####.#..####....##.
#..####.##.##..###..#.#...#.######.#.#.#.......######......#...###.####...#..#..#.#.###.#.##.#..#..#
#..#####.....###....#..##..#...##...#.####..##...#..##.#.#...#.#.......#...#.#....##.##.#..#..#.###.
.#.#..#..##.##.#.##..##....###...#..#.#.#..##..#.####...#..##...###.#.#.#..#.#..##..##.#.##......###
##.#.###...#.#.#.#..#.....##.....##.#.#.#.###..#.#...####..###.##...#..#.##....##....#...#..#.###..#
###..#.#.#.....#....#.##.####..###.#####..#..########.##.#.#..#...#####..####.#...#..###..###...#..#
#.#.##..###..##.##.#.#..###.##...#..#..#..#...#..#.#.###...#..##.##.##..###.#.#.#..#....#....####.#.
#.###.#..##..#.###.#####.#..#.###..##...#..#.#.###...##.#...###...#...#...##..#...##.#..##.##.###...
.#.###..#.#.#.####.#.##...#....#....#.#.##....##.#####.#....#....#####..#.#......###....###..##....#
.##.......#...#.#.#....#....#..#..#.###.#.#.##########.##..#####..#.#.##...#..#.###.#...#.#....#####
..#..#.###.#.#.####..###.####.#.###.#..#..#.#...#..#.#..####.#.#####.#..#...##.#.#.###.##.####......
.##..#..#####...#..#.#..#.......#.#.#.#..####.##..#..##.##...#...######..####...#....#....##.#.#.##.
...#.##.#..##..#.##.##.##.#.#.....#.....#..#.#.#..#...####.#####.##.###.#..####..####..#.##....###.#
.##.##......##.#..#....#######..##.####.#...######....######.##.#.##..#..#.#..##..##.#.#####.#.....#
###..#####.#..#...#.##...###...##.#.##..##.##.####.###..#.##.#.##.###....#..#.##.###..##.##.##..##.#
.#.#.##.#.......#.#..#...#.######..#..##.##.##.###.##.###.#.#.#...#..##.##.###..#..#..#..##..#.#.#..
##..###..#...##.#....##....#...##.#.#####.#..#.###.#..#..#####.##.#######.####.##.#..##.##..#.####.#
.#..###.##...#.#.###.#.#.##.##.#.#...#..#.###..#.#.#####..#..###...#.#..#.###......###.#.#...##.##.#
...#.#..#...###...#..#####.##..####..###.###.#....#....#...#.###.#..##.#.#.##...#.###..###..##.##.#.
##..#.#.###.#####...#####..#.###..##.#.#.#...##.#####.####.....#.###...##.####.#...#....#..#..###.##
#.....#.#.##.###...#..######.#.#.#######.#..#.##.#.#...#..###.###.#..........####..#..#...#######...
.##..##.#..#.#...##.###.....##.#..#...#..##.#.....#.#.#.##.###.#######..###.....#.###..#....##.#.#..
.##.#.##.....#...#...#.#.#..#......##.#.##.#..#....#....#####.######..#......####...#.###.##.##..##.
.#.####....###...#..##.#####.#....##.#.##..#.#.#.#.##.#.#......###.#..###.###.....#.#.###...#.##.#..
..#.....##...##...#.#..##...#.....#..#.#.####.#......#.###...#.#.#..##.##.##.##.#....##..###.#.#.#.#
#.###..#...#..#.#.....##.####.#......#####...#####.##.#######..####.......##.###....#.###....##..#..
##.#.#..........#....###...##.###.##.#.#....##..#....#.##.##..####...##...##.##..#.#.#######..###.##
.###.##.#..###############.#.#..#..##..#.#####.##.#..##.#......#.##...####.......#####..########.#.#
......#..#..#.#####.#..#.#.##.##..###.###..####.##...#.#.....####..#..#..#..##...#.#..#.###.#..##...
#....###...##.###..###..#.##.....#.#....##..###..###.##..##..#.##..###.##.##.#..#.....##.#.#.##.....
.#.###.###..#.##..#...##..##..##....#..#..#..####.##..##..##....#.##..#.#...#....###.##..#.#..#.#.##
.#.#.###.#..###.#..#.#.#.##..#.#...#####.#.#.########.###...####.##.....#...#..#..####..#.########..
..##.##.#.##.##.##..##.#..#.##.##.##.########.####...##.#.##.#####...###..#....##....##..#..####...#
..##.###.......##......##.#####.####.###.#.#.#.#.#.#.##.###.#...#.#..##..#....#......#.#..#....#.#..
######..#..######..##.##.#..#..##...#.#.##.##.#.####.##..##..#.###.#...##..#..#.#........##.##.##...
.#..##...#.#..##.#.....######..#.#######..#.#..#.##.##.#.####.#..##.#..#...#..##...#.#.###.######.##
......#....##.####....#.####..#..#...####...#.##..##....##....##.#.#.##.########..#....#.###.#...#.#
.......#.....#.#.##..#....##.###.#..##.#.#...#..#......#.#..#......#...#....#..#.##....###.##.###...
#..#.##.#...#.##..######..#.##...###..#...#..####.#......#..#.#..##.#.####.#...##.#...#.#.#..##.#.#.
#...##.#...#.##..#.##..#..#.#.#..#.##...######..#..#..#..#..#...###..##.###.#.#...#..####.####...#.#
####.#....###.#..##.#.#..#...#..##.##.##...##.#########..#.......#######...#.#.####.#...#...##....##
.##..#.#..#.#.#..#.###.##.##.#.#.#####.......#####.......#.#.##.##..##......#.#####..###......#..###
...##..#.#.##..#######.#..#..#.....#..#.########..###.###.#.##.#..###...#..#....##.#.#####.##.##.#.#
##....#...#.###.#...#....###.#.#...###.....##.##.#...#.##..##.##.##.##....##.##.##.##.####.......#.#
##.####.###..####..#...###..####.##.##.#######.#..####.##.######.#...#.####.##.##.#....#.##..#.#.##.
..##..######.#.#.##..#..#####..#.#..#......###..######.##....#........#.##.#.##.##.#.....###...#.#.#
#.#...#..##.#..##.#.#..#..######.#....#..##.#....###..##.#.#.#.#.#..###.###.###..##...#.......##.#.#
#.#.#.#####.##...####.##.##.##...#..##.##.##.###.#...##...#.##..##..#.#...##..#....##..#......#####.
##.##.....#.#.#...####.#...#####.##...#.....#..#..#.#.#.#..#....#.#.##....##.##....##.##.#.#......##
#.#.##..#.#..#.....#..#.#..###.#..#####....####..######..#..##.#.#.#..##..####.....#######...#.#.##.
##...###.....##...#.#.##.####..#...###.#..######.....######....##..####..#####..##.###......#..##..#
##.#.###.#.##.####.###.##..##........#..#####.....#.###.#.#....##.#.###.#...#.#..#.........##.#.##..
....#.####...#.#........###..#.###.###..####..####...#.##...###########.#.##.###..#..####.#..#.##.##
.#####....##.#.#..#..#.##...##......##.#.#....######.......###.#.#.##.#.....#...#.#.....#.###...###.
##..#..####..###.###...#...#.##.#.#..##.#.##.##.##....#.#.#...#...#..#.#.###....#..##.......##.#.#..
##.#.#.##.#.#.######..###..#..####.........##.#..##########.###..#.#..#...##.##...#####.....#.#..#.#
##.#..#..#.#.##...######.#...##..###..##..##.#..####..#..##.#....##.#........#####.###...###.##...#.
....#.#.##...##...##..####.#####.#.#####.#..#.########....##.....###.#.##.#..####.##.#.....###.#.#..
#####.#.#.###.#####.##...###.####..##.##..##.##.##.#.###.####..##...#.##.#..##...######...#.....##.#
#..##.#.###.###....#..###..........#.##.#..#.#.####..#.####..###......##.....#.###....###.#.....#.##
.######...#####.###..##.#......###...###..#.#.#.###..#.###.....#.#...##..#..##.##.##..#......#.####.
#..##..#...##.##...###......#..#.###..###..##....##...##.##.#...####.####..##...##.#..#....##.#.#.#.
#.##..##.......#.#.##.##.#....###....#.###.##.#....#.#..####....###.##.#.##...#..#.##...#......#.#..
..#..#...#.....#.##.#.####......#....#.##...###.#...##.#..#..#......#...##.###.###..#.##.####...#...
#..##.##.#.##..####.#.##...#.#.#.#.##.#.##....#.#.#...#.####...####.#.##......###..#..##.##...#..#.#
...#..#.#.#...#....####.#.##....###.#..#.####.##..#.##.##...#.#.##.#.#.....#.....###.###..###.#####.
..#.####.....#..##.##..#...##..#...##....#.#####.#..#...#..#..#..#####.#.##.#.....#.###..###..#...##
#.##...#.##...#..#.......#.....###...##.#..#.......#...#.#..####...#...#..##....####..#..###.#..#...
......##...#..#..####..##.#.#...#.#...###....###.##..#.#.##.#.##.##.#.#.#####.##.####.###.#.#.###...
#.#.#.#..#...#...#....##.######....###.#..#..#.#..##..##.###...#..#.##...###..####...###...##.######
.####..###.#.#...#.#.#.#..###....##.###.##.....#.#.####...#.##..###.#.####.##.###..###.##..#.....#.#
.......#..##.##.######..#.####.#...##.##..##.##.##.#.##.##.#.#...##.#.#..#..#.#..#.#.##.###.###.#...
.#.......#..#.#..#.#..##...##..#.....#.#.##.##...#.#######.#.##.#..#....#.##...#####..###.#.#.#.##..
##.##..#.###...##......#..#.#.#..#...#.#.#...##.###..#.#####..###.##....#..###.......##.#...#..#.###
#.####..#....#...###.#.##.##..#..#..###...#..#.####.##....#.#..#..#.##.##..###.##.##..##.#.#.##.###.
###.#...###...##...##.#..#..#####.#....##.#..##...###..#..##.#.####.##.#..###.##..#.#..##....#..##..
#.####.####.##.#.....###..#.##..##..#....#......##...#...#.###..##.###..#......####.##.#..#.#.##.#..
.......###.#.#.....####.#..####.......##......#.#.#....#####...##..###.....#.#..###..#.####.##.#.###
#..#..#...#..#####..###..#..##.#.#...####..#.#......#.#...##.##..#.##.####..#####.####..#.#..####.##
#..######..#......#..####..##....###.#.##.#.#.#####.#.##.#..##..#.##.####.#.##.#.#.###..###.###...##
...#.#.####.##..##....####..#......###..##...##.#...#.#...#..#.#..##....###.##.#..#####.##..###.#.##
..#####.##..####..#...#...#.###..#..##.#..#.#....#.####.##...#.#####..#.##..#.#######.#..#.##......#
##....##.#.#.#.##...######..##..#.#.##....##.#...###.#..######.#.##..######.##..#...#..#..###..#.##.
.###...###..#####.#......####.......####..#.....##..#.##..#..#####..##.#...#.#...#.###..###....#####
.###.#...#.##.#.##.#.....#..#..#.#####.....####.##..####..#...#.###.#..#.##.#...####..#....#.##...#.
#...##..##.#.##.###.##..#..#.....#..#.###.####.#...#.##.##....#.#.#####.######.#...###.##.#.#.#.#.#.
#.#####...#.#.#####..#.#..#...######...##.##.###.#....#..###.........#.##...#.##...#.##...####....#.
.###.#####..##.##..#.###.....######.######....##..##.#.##.#####..###..###...##.#..##.#..#..........#
....#.#.#.##...#####..###...#..#.####.##..####...####..........#....#.#.#..#...####.##.........#####
####.##..##...#.#.###..#####.....##.#....#.#...#.#####.#####...#.##.##..###.......##.##..##..####.#.
#..#####...##....#.#.#######.#..##..##..##.#..######.###.#.###..##.####.##..#.#.##.##..#.##.#.###.##
#####...#...#.##.##..##.###.##.###..####...##..##..#.#.#.#.#.####.#.#..#.###...#.#........#..###.#..
.###.#..#.##.#.####.#....###..#.#.##.#.....#..#.###..####..###..#.##.#.##.##.....###..#.##...#..#...
.#.#....#.###.#.#...#.#.##..#..#....#####.....###.###..#.####..###.###.#####...#..#.###.#..##.#..##.
.##...#.#....###...###.#.#.##.##.#..###.#.#...#.###.#.#...##..###.##.......#....#..#..#...#..#...###
.###.###.###.##.#.#.#...#.#..#..#.#.#.#.#.#.##.###.##.##..##..#...#.#.####..#.##..##......#...#.#.##
#####.#........#...#####..#.#.####..##.##..##..####.#......##.#.....#..#.###.#..######.#..#.#..#..#.
#...#..####...###.#####..#.#.#..####....#.##..##..#..#.#..###.....#...#.#....##.###.....#...###.###.
...#......#...#.###.#...#....##.....##...###.###.#....##.##.#...##.####.#.##.###.##.###..#.#.###.##.
#####...###.##.##.#..###.#...#..#..#..#...#####.#####..#..#......#.#.######.##.#########..##.###..#.`;

var input =
  typeof document === "undefined" ||
  document.body.innerText.includes("get your puzzle input")
    ? real//practice
    : document.body.innerText.trim();

var decoder = input.split('\n')[0].split('').map(x => x == '#');

var inputImage = input.split('\n\n')[1].split('\n').map(x => x.split('').map(y => y == '#'));

console.log(inputImage[3][1]);



// //console.log(`${minX},${maxX},${minY},${maxY}`);

var outputImage = inputImage;
// console.log(outputImage);

var numberOfIterations = 01;

for (var i = 0; i < numberOfIterations; i++) {
  outputImage = [];
  var minX = Object.keys(inputImage).map(Number).sort()[0];
  var maxX = Object.keys(inputImage).map(Number).sort((x,y) => y-x)[0];
  var minY = inputImage.flatMap(x => Object.keys(x).map(Number)).sort()[0];
  var maxY = inputImage.flatMap(x => Object.keys(x).map(Number)).sort((x,y) => y-x)[0];
  var minVal = Math.min(minX, minY) - 2;
  var maxVal = Math.max(maxX, maxY) + 2;
  console.log(`${minVal},${maxVal}`);
  for (var y = minVal; y < maxVal; y++) {
    outputImage[y] = outputImage[y] || [];
    for (var x = minVal; x < maxVal; x++) {
      outputImage[y][x] = getPixelValue(x,y);
    }
  }

  inputImage = [];
  Object.keys(outputImage).sort().forEach(yKey => {
    inputImage[yKey] = inputImage[yKey] || [];
    Object.keys(outputImage[yKey]).sort().forEach(xKey => {
      inputImage[yKey][xKey] = outputImage[yKey][xKey];
    });
  });
  //no no not this \/
  //inputImage = outputImage.map(r => r.map(j => j));
}

function getPixelValue(x, y) {
  //console.log(`${x},${y}`);
  var value = [];
  for (var y1 = y - 1; y1 < (y + 2); y1++) { 
    inputImage[y1] = inputImage[y1] || [];
    for (var x1 = x - 1; x1 < (x + 2); x1++) {
      //console.log(`${x1},${y1}`);
      var foundElement = inputImage[y1][x1];
     //console.log(foundElement);
      value.push((foundElement != undefined) && foundElement);
      //console.log(`${x1},${y1}`);
    }
  }
  value.reverse();
  //console.log(value);
  var index = value.reduce((prev, curr, idx) => prev + ((curr ? 1 : 0) * Math.pow(2, idx)),0);
  if (index < 0 || index > 511 || value.length != 9) {
    console.log(`ERROR: ${x},${y}: ${index}=>${pixel}`);
  }
  var pixel = decoder[index];
  // console.log(pixel);
  return pixel;
}
// // console.log(inputImage);

 //console.log(getPixelValue(2,2));
 //console.log(outputImage);
 var str = '';
 
var numberOfTrues = 0;
 Object.keys(outputImage).forEach(yKey => {
   Object.keys(outputImage[yKey]).forEach(xKey => {
     var t = (outputImage[yKey][xKey] != undefined) && outputImage[yKey][xKey];
     numberOfTrues += t ? 1 : 0;
     str += t ? '█' : '▯';
     //console.log(`${xKey},${yKey} ${outputImage[yKey][xKey]}`);
   });
   str += '\n';
 });
 console.log(str);

//  var numberOfTrues = outputImage.flatMap(x => x.map(y => y)).filter(x => x).length;
 console.log(numberOfTrues);

 //5905 too high